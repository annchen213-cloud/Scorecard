<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2025 業務績效評核系統 (單機版)</title>
    <!-- 使用 defer 屬性避免阻塞渲染 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @media print {
            .no-print { display: none !important; }
            .print-show { display: block !important; }
            body { background-color: white; }
            .page-break { page-break-before: always; }
            textarea { border: 1px solid #ddd; resize: none; overflow: hidden; }
            select { appearance: none; border: none; background: transparent; font-weight: bold; }
        }
        .tab-active { border-bottom: 2px solid #2563eb; color: #2563eb; }
        .tab-inactive { border-bottom: 2px solid transparent; color: #6b7280; }
        .tab-inactive:hover { color: #374151; border-color: #d1d5db; }
        
        /* 載入動畫過場效果 */
        #loading { transition: opacity 0.5s ease-out; }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-800 pb-20 print:pb-0">

    <!-- Navbar -->
    <header class="bg-white shadow-sm sticky top-0 z-10 no-print">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-16">
                <div class="flex items-center">
                    <i data-lucide="award" class="h-8 w-8 text-blue-600 mr-2"></i>
                    <h1 class="text-xl font-bold text-gray-900 hidden sm:block">2025 業務績效評核系統 (單機版)</h1>
                    <h1 class="text-xl font-bold text-gray-900 sm:hidden">2025 績效評核</h1>
                </div>
                <div class="flex items-center space-x-4">
                    <span id="storage-indicator" class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded-full flex items-center">
                        <i data-lucide="hard-drive" class="w-3 h-3 mr-1"></i> 本機儲存
                    </span>
                    <span id="saveStatus" class="text-xs text-gray-500 hidden md:inline"></span>
                    <button onclick="window.print()" class="p-2 text-gray-600 hover:text-blue-600 transition-colors" title="列印">
                        <i data-lucide="printer" class="h-5 w-5"></i>
                    </button>
                    <button id="btnSave" class="flex items-center px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md shadow-sm text-sm font-medium transition-all">
                        <i data-lucide="save" class="mr-2 h-4 w-4"></i> 儲存資料
                    </button>
                    <button onclick="clearData()" class="p-2 text-red-400 hover:text-red-600 transition-colors" title="清除所有資料">
                        <i data-lucide="trash-2" class="h-5 w-5"></i>
                    </button>
                </div>
            </div>
            
            <!-- Tabs -->
            <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                <button onclick="switchTab('scorecard')" id="tab-scorecard" class="tab-active whitespace-nowrap py-4 px-1 font-medium text-sm flex items-center">
                    <i data-lucide="file-text" class="mr-2 h-4 w-4"></i> 績效評核表 (量化)
                </button>
                <button onclick="switchTab('interview')" id="tab-interview" class="tab-inactive whitespace-nowrap py-4 px-1 font-medium text-sm flex items-center">
                    <i data-lucide="message-square" class="mr-2 h-4 w-4"></i> 績效訪談表 (質化)
                </button>
            </nav>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8 print:p-0 print:max-w-full">
        
        <!-- Loading Spinner -->
        <div id="loading" class="fixed inset-0 bg-white/95 flex items-center justify-center z-50 transition-opacity duration-500">
            <div class="text-center">
                <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mx-auto mb-4"></div>
                <p class="text-gray-600 font-medium">系統載入中...</p>
            </div>
        </div>

        <!-- User Info -->
        <div class="bg-white shadow rounded-lg mb-6 p-6 print:shadow-none print:border print:mb-4">
            <h2 class="text-lg font-medium text-gray-900 mb-4 flex items-center">
                <i data-lucide="user" class="mr-2 h-5 w-5 text-gray-500"></i> 基本資料
            </h2>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                <div>
                    <label class="block text-sm font-medium text-gray-700">姓名</label>
                    <input type="text" id="meta-name" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">職稱</label>
                    <input type="text" id="meta-title" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">到職日</label>
                    <input type="date" id="meta-hireDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">填表日</label>
                    <input type="date" id="meta-fillDate" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm border p-2 focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
        </div>

        <!-- Tab 1: Scorecard -->
        <div id="view-scorecard" class="print-show">
            <!-- Legend -->
            <div class="bg-blue-50 border-l-4 border-blue-400 p-4 mb-6 rounded-r-lg print:break-inside-avoid">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i data-lucide="alert-circle" class="h-5 w-5 text-blue-400"></i>
                    </div>
                    <div class="ml-3">
                        <h3 class="text-sm font-medium text-blue-800">評分標準說明</h3>
                        <div class="mt-2 text-sm text-blue-700 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-2">
                            <span><b>5分:</b> 表現優異，遠超標準</span>
                            <span><b>4分:</b> 表現良好，高於標準</span>
                            <span><b>3分:</b> 達到基本標準</span>
                            <span><b>2分:</b> 表現稍微不足</span>
                            <span><b>1分:</b> 表現不足，需大幅改善</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Table -->
            <div class="bg-white shadow rounded-lg overflow-hidden print:shadow-none print:border">
                <div class="p-6 border-b border-gray-200 flex justify-between items-center bg-gray-50 print:bg-gray-100">
                    <h3 class="text-lg font-medium text-gray-900">績效評核項目</h3>
                    <div class="text-sm bg-white px-3 py-1 rounded border shadow-sm">
                        目前平均: <span id="display-avg" class="font-bold text-blue-600 text-lg">0.0</span> / 5
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/4">評核項目 / 定義</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">自評分數</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">自我優化方式 / 具體事蹟</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">希望提供協助方式</th>
                            </tr>
                        </thead>
                        <tbody id="kpi-table-body" class="bg-white divide-y divide-gray-200">
                            <!-- JS will populate rows here -->
                        </tbody>
                    </table>
                </div>
                <div class="p-4 bg-gray-50 border-t border-gray-200 flex justify-end items-center">
                    <div class="text-right">
                        <div class="text-sm text-gray-500">自評總分: <span id="display-sum">0</span></div>
                        <div class="text-lg font-bold text-gray-900">總平均: <span id="display-avg-bottom">0.0</span></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab 2: Interview -->
        <div id="view-interview" class="hidden print-show print:mt-8">
            <!-- Targets -->
            <div class="bg-white shadow rounded-lg mb-6 overflow-hidden print:shadow-none print:border print:break-inside-avoid">
                <div class="p-6 border-b border-gray-200 bg-gray-50 print:bg-gray-100">
                    <h3 class="text-lg font-medium text-gray-900 flex items-center">
                        <i data-lucide="target" class="mr-2 h-5 w-5 text-red-500"></i> 2026 年度業績目標規劃
                    </h3>
                    <p class="text-sm text-gray-500 mt-1">請填寫預估的每月業績目標金額或關鍵指標。</p>
                </div>
                <div class="p-6 grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4" id="target-grid">
                    <!-- JS will populate targets -->
                </div>
            </div>

            <!-- Questions -->
            <div class="space-y-6" id="questions-container">
                <!-- JS will populate questions -->
            </div>

            <!-- Signature -->
            <div class="hidden print:block mt-12 pt-8 border-t-2 border-gray-300 break-inside-avoid">
                <div class="flex justify-between px-12">
                    <div class="text-center">
                        <p class="text-lg mb-12">員工簽名：______________________</p>
                        <p class="text-sm text-gray-500">日期：</p>
                    </div>
                    <div class="text-center">
                        <p class="text-lg mb-12">主管簽名：______________________</p>
                        <p class="text-sm text-gray-500">日期：</p>
                    </div>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- Data Definitions ---
        const KPI_ITEMS = [
            { category: "工作職能", item: "開發新客戶", desc: "能夠有效識別並開發潛在客戶，創造新商機。", id: "kpi_1" },
            { category: "工作職能", item: "客戶維護與關係管理", desc: "與現有客戶維護及建立穩固的關係，促使客戶定期出貨。", id: "kpi_2" },
            { category: "工作職能", item: "銷售目標達成", desc: "完成設定的銷售目標，超越預期業績。", id: "kpi_3" },
            { category: "工作職能", item: "應收帳款", desc: "按時完成應收賬款的催收與管理。", id: "kpi_4" },
            { category: "工作職能", item: "市場情報收集與競爭分析", desc: "積極收集市場信息，分析競爭環境，調整銷售策略。", id: "kpi_5" },
            { category: "個人能力", item: "溝通能力", desc: "擅長與各類型客戶進行溝通，能清晰表達產品價值。", id: "kpi_6" },
            { category: "個人能力", item: "解決問題的能力", desc: "面對挑戰時能迅速提出解決方案，並有效處理問題。", id: "kpi_7" },
            { category: "個人能力", item: "學習能力與成長", desc: "持續學習新知識，不斷提升自身業務能力。", id: "kpi_8" },
            { category: "工作態度", item: "時間管理與工作效率", desc: "能夠有效安排工作時間，提升工作效率。", id: "kpi_9" },
            { category: "工作態度", item: "顧客服務態度", desc: "可以滿足顧客需求，提供量身定制的解決方案。", id: "kpi_10" }
        ];

        const INTERVIEW_QUESTIONS = [
            { id: "q1", question: "1. 今年你最滿意的工作表現或專案是什麼？為什麼？", placeholder: "請描述具體案例與成果..." },
            { id: "q2", question: "2. 今年在工作中最有挑戰的部分是什麼？你是如何解決的？", placeholder: "遇到的困難點及應對方式..." },
            { id: "q3", question: "3. 今年有哪些新技能、新工具或工作方式是你主動學習或嘗試的？對工作有什麼幫助？", placeholder: "例如：新軟體、新的談判技巧..." },
            { id: "q4", question: "4. 回顧這一年，你覺得自己在哪個面向成長最多？還有哪個地方希望再加強？", placeholder: "自我反思與成長規劃..." },
            { id: "q5", question: "5. 如果要讓各部門或同事間合作更順暢，你覺得主管或團隊可以在哪些地方提供協助或改進？", placeholder: "具體的協作建議..." },
            { id: "q6", question: "6. 今年哪一堂公開班課程印象最深刻？為什麼？在這堂學到了什麼？", placeholder: "課程名稱、講師風格、應用於工作的點..." },
            { id: "q7", question: "7. 明年公司開什麼課程，對你最有幫助？", placeholder: "希望學習的主題..." }
        ];

        const MONTHS = Array.from({ length: 12 }, (_, i) => `${i + 1}月`);
        const STORAGE_KEY = 'performance_review_2025_data';

        // --- State ---
        let formData = {
            meta: { name: "", title: "", hireDate: "", fillDate: new Date().toISOString().split('T')[0] },
            scores: {},
            interview: {},
            targets: {}
        };

        // --- UI Rendering ---
        
        function renderTables() {
            // Render KPI Table
            const tbody = document.getElementById('kpi-table-body');
            tbody.innerHTML = KPI_ITEMS.map(item => `
                <tr class="hover:bg-gray-50 print:break-inside-avoid">
                    <td class="px-6 py-4 whitespace-normal">
                        <div class="text-sm font-bold text-gray-900">${item.item}</div>
                        <div class="text-xs text-gray-500 mt-1">${item.desc}</div>
                        <div class="text-xs text-blue-500 mt-1 inline-block px-2 py-0.5 bg-blue-50 rounded-full">${item.category}</div>
                    </td>
                    <td class="px-6 py-4 align-top">
                        <select onchange="updateScore('${item.id}', 'score', this.value)" class="block w-full rounded-md border-gray-300 shadow-sm border p-2 text-sm" id="score-${item.id}">
                            <option value="5">5</option>
                            <option value="4">4</option>
                            <option value="3" selected>3</option>
                            <option value="2">2</option>
                            <option value="1">1</option>
                        </select>
                    </td>
                    <td class="px-6 py-4 align-top">
                        <textarea rows="3" onchange="updateScore('${item.id}', 'selfNote', this.value)" class="w-full rounded-md border-gray-300 shadow-sm border p-2 text-sm" placeholder="說明..." id="selfNote-${item.id}"></textarea>
                    </td>
                    <td class="px-6 py-4 align-top">
                        <textarea rows="3" onchange="updateScore('${item.id}', 'helpNote', this.value)" class="w-full rounded-md border-gray-300 shadow-sm border p-2 text-sm" placeholder="協助..." id="helpNote-${item.id}"></textarea>
                    </td>
                </tr>
            `).join('');

            // Render Target Grid
            const targetGrid = document.getElementById('target-grid');
            targetGrid.innerHTML = MONTHS.map(m => `
                <div class="relative rounded-md shadow-sm">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <span class="text-gray-500 text-sm">${m}</span>
                    </div>
                    <input type="text" onchange="updateTarget('${m}', this.value)" id="target-${m}" class="block w-full pl-16 text-sm border-gray-300 rounded-md border p-2" placeholder="目標...">
                </div>
            `).join('');

            // Render Questions
            const qContainer = document.getElementById('questions-container');
            qContainer.innerHTML = INTERVIEW_QUESTIONS.map(q => `
                <div class="bg-white shadow rounded-lg overflow-hidden print:shadow-none print:border print:break-inside-avoid">
                    <div class="px-6 py-4 border-b border-gray-200 bg-gray-50 print:bg-gray-100">
                        <h3 class="text-md font-medium text-gray-900">${q.question}</h3>
                    </div>
                    <div class="p-6">
                        <textarea rows="5" onchange="updateInterview('${q.id}', this.value)" id="interview-${q.id}" class="block w-full text-sm border-gray-300 rounded-md border p-3" placeholder="${q.placeholder}"></textarea>
                    </div>
                </div>
            `).join('');
            
            // Re-render Icons
            if (window.lucide) lucide.createIcons();
        }

        // --- Logic & Data Handling ---

        window.updateScore = (id, field, value) => {
            if (!formData.scores[id]) formData.scores[id] = { score: 3, selfNote: "", helpNote: "" };
            formData.scores[id][field] = value;
            calculateTotal();
            // Auto save on change for local version
            debouncedSave();
        };

        window.updateInterview = (id, value) => {
            formData.interview[id] = value;
            debouncedSave();
        };

        window.updateTarget = (month, value) => {
            formData.targets[month] = value;
            debouncedSave();
        };

        function calculateTotal() {
            let sum = 0;
            let count = 0;
            KPI_ITEMS.forEach(item => {
                const val = formData.scores[item.id]?.score || 3;
                sum += parseInt(val);
                count++;
            });
            const avg = (sum / count).toFixed(1);
            document.getElementById('display-sum').innerText = sum;
            document.getElementById('display-avg').innerText = avg;
            document.getElementById('display-avg-bottom').innerText = avg;
        }

        function populateForm() {
            // Meta
            document.getElementById('meta-name').value = formData.meta.name || "";
            document.getElementById('meta-title').value = formData.meta.title || "";
            document.getElementById('meta-hireDate').value = formData.meta.hireDate || "";
            document.getElementById('meta-fillDate').value = formData.meta.fillDate || new Date().toISOString().split('T')[0];

            // Scores
            KPI_ITEMS.forEach(item => {
                const data = formData.scores[item.id] || { score: 3, selfNote: "", helpNote: "" };
                document.getElementById(`score-${item.id}`).value = data.score;
                document.getElementById(`selfNote-${item.id}`).value = data.selfNote;
                document.getElementById(`helpNote-${item.id}`).value = data.helpNote;
            });

            // Targets
            MONTHS.forEach(m => {
                document.getElementById(`target-${m}`).value = formData.targets[m] || "";
            });

            // Interview
            INTERVIEW_QUESTIONS.forEach(q => {
                document.getElementById(`interview-${q.id}`).value = formData.interview[q.id] || "";
            });

            calculateTotal();
        }

        // --- Tab Logic ---
        window.switchTab = (tab) => {
            const tab1Btn = document.getElementById('tab-scorecard');
            const tab2Btn = document.getElementById('tab-interview');
            const view1 = document.getElementById('view-scorecard');
            const view2 = document.getElementById('view-interview');

            if (tab === 'scorecard') {
                tab1Btn.className = "tab-active whitespace-nowrap py-4 px-1 font-medium text-sm flex items-center";
                tab2Btn.className = "tab-inactive whitespace-nowrap py-4 px-1 font-medium text-sm flex items-center";
                view1.classList.remove('hidden');
                view2.classList.add('hidden');
            } else {
                tab1Btn.className = "tab-inactive whitespace-nowrap py-4 px-1 font-medium text-sm flex items-center";
                tab2Btn.className = "tab-active whitespace-nowrap py-4 px-1 font-medium text-sm flex items-center";
                view1.classList.add('hidden');
                view2.classList.remove('hidden');
            }
        };

        // --- Event Listeners for Meta ---
        ['name', 'title', 'hireDate', 'fillDate'].forEach(field => {
            document.getElementById(`meta-${field}`).addEventListener('change', (e) => {
                formData.meta[field] = e.target.value;
                debouncedSave();
            });
        });

        // --- Local Storage Logic ---
        function loadData() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Merge to ensure structure integrity
                    formData = {
                        meta: { ...formData.meta, ...parsed.meta },
                        scores: { ...formData.scores, ...parsed.scores },
                        interview: { ...formData.interview, ...parsed.interview },
                        targets: { ...formData.targets, ...parsed.targets }
                    };
                    console.log("Data loaded from local storage");
                }
            } catch (e) {
                console.error("Failed to load local data", e);
            }
            populateForm();
            
            // Hide loading
            const loader = document.getElementById('loading');
            loader.style.opacity = '0';
            setTimeout(() => loader.style.display = 'none', 500);
        }

        window.saveData = () => {
            const btn = document.getElementById('btnSave');
            btn.innerHTML = `<div class="animate-spin h-4 w-4 border-2 border-white border-t-transparent rounded-full mr-2"></div> 儲存中...`;
            btn.disabled = true;

            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
                
                // Success UI
                document.getElementById('saveStatus').innerText = `上次儲存: ${new Date().toLocaleTimeString()}`;
                setTimeout(() => {
                    btn.innerHTML = `<i data-lucide="check" class="mr-2 h-4 w-4"></i> 儲存成功`;
                    btn.classList.replace('bg-blue-600', 'bg-green-600');
                    btn.classList.replace('hover:bg-blue-700', 'hover:bg-green-700');
                    if (window.lucide) lucide.createIcons();
                }, 400);

                setTimeout(() => {
                    btn.innerHTML = `<i data-lucide="save" class="mr-2 h-4 w-4"></i> 儲存資料`;
                    btn.classList.replace('bg-green-600', 'bg-blue-600');
                    btn.classList.replace('hover:bg-green-700', 'hover:bg-blue-700');
                    btn.disabled = false;
                    if (window.lucide) lucide.createIcons();
                }, 2000);
            } catch (e) {
                console.error("Save failed", e);
                alert("儲存失敗：請檢查瀏覽器設定是否允許 LocalStorage");
                btn.disabled = false;
                btn.innerHTML = `<i data-lucide="save" class="mr-2 h-4 w-4"></i> 儲存資料`;
                if (window.lucide) lucide.createIcons();
            }
        };

        window.clearData = () => {
            if(confirm('確定要清除所有資料嗎？此動作無法復原。')) {
                localStorage.removeItem(STORAGE_KEY);
                location.reload();
            }
        }

        // Debounce helper for auto-save
        let timeout;
        function debouncedSave() {
            document.getElementById('saveStatus').innerText = "編輯中...";
            clearTimeout(timeout);
            timeout = setTimeout(() => {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(formData));
                document.getElementById('saveStatus').innerText = "已自動儲存";
            }, 1000);
        }

        document.getElementById('btnSave').addEventListener('click', window.saveData);

        // --- Init ---
        // Wait a bit for DOM to be super ready and scripts loaded
        window.addEventListener('DOMContentLoaded', () => {
            renderTables();
            // Artificial small delay to make transition smoother
            setTimeout(loadData, 300);
        });

    </script>
</body>
</html>
